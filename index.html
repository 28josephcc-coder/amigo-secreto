<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Amigo Secreto Reales</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b1220; --card:#0f1724; --accent:#e53e3e; --accent2:#f6ad55;
    --muted:#94a3b8; --glass: rgba(255,255,255,0.06);
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  html,body{height:100%}
  body{
    margin:0;
    min-height:100%;
    /* fondo navideÃ±o nÃ­tido, pero con overlay oscuro para legibilidad */
    background: url('https://images.unsplash.com/photo-1542282811-943ef1a977c4?auto=format&fit=crop&w=1800&q=80') no-repeat center center fixed;
    background-size:cover;
    color:#e6eef8;
    padding:20px;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* overlay para que el fondo no opaque el contenido */
  .page-overlay{
    background: rgba(2,6,23,0.46);
    min-height:100%;
    padding:18px;
    border-radius:12px;
  }

  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  h1{margin:0;font-size:20px;display:flex;gap:12px;align-items:center}
  .controls{display:flex;gap:8px;align-items:center}

  /* contenedor principal */
  .wrap{max-width:1200px;margin:0 auto}

  /* formulario superior */
  .top-form{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    padding:12px;border-radius:12px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.5);
  }
  .top-form select, .top-form input { background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:inherit;min-width:150px }
  .top-form button{background:linear-gradient(90deg,var(--accent),var(--accent2));border:0;padding:9px 12px;border-radius:10px;color:white;cursor:pointer}
  .top-form .small{font-size:13px;color:var(--muted)}

  /* grid de tarjetas */
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
  .card{
    background: rgba(255,255,255,0.06); /* blanco translÃºcido */
    border-radius:14px;padding:14px;min-height:220px;display:flex;flex-direction:column;align-items:center;
    box-shadow: 0 8px 24px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)
  }

  .person-photo{
    width:86px;height:86px;border-radius:50%;object-fit:cover;border:3px solid rgba(255,255,255,0.12);margin-bottom:10px;background:#071226;
  }
  .card h3{margin:0;font-size:16px;color:#ffdca1}
  .wish{width:100%;margin-top:10px;background:rgba(0,0,0,0.18);padding:8px;border-radius:8px;font-size:14px;color:#fff8dc}
  .wish .label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  .gift-photo{width:100%;height:120px;object-fit:cover;border-radius:8px;margin-top:8px;display:block;border:1px solid rgba(255,255,255,0.03)}

  .muted{color:var(--muted);font-size:13px}

  footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}

  /* responsive */
  @media (max-width:1100px){ .grid{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:820px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:520px){
    .top-form{flex-direction:column;align-items:stretch}
    .grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="page-overlay">
    <div class="wrap">
      <header>
        <h1>ðŸŽ„ Amigo Secreto Reales</h1>
        <div class="controls"><div class="muted">Todos ven las tarjetas â€” edita solo la tuya</div></div>
      </header>

      <!-- FORMULARIO SUPERIOR: seleccionar nombre y editar solo TU tarjeta -->
      <div class="top-form" role="region" aria-label="Formulario de ediciÃ³n">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label class="small muted" style="margin-right:6px">Soy:</label>
          <select id="selectName"></select>
        </div>

        <input id="personalPhoto" type="url" placeholder="URL foto personal (tu foto)" />
        <input id="giftPhoto" type="url" placeholder="URL imagen del regalo" />
        <input id="wish1" type="text" placeholder="DESEO 1" />
        <input id="wish2" type="text" placeholder="DESEO 2" />
        <button id="saveBtn">Actualizar mi tarjeta</button>
      </div>

      <!-- Grid con las tarjetas -->
      <section class="grid" id="cardsGrid" aria-live="polite"></section>

      <footer>Usa Export/Import si quieres respaldo local â€¢ App ejemplo</footer>
    </div>
  </div>

  <!-- Firebase + Firestore (mÃ³dulo moderno) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import {
      getFirestore, collection, doc, setDoc, getDoc, onSnapshot, query
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // --- TU CONFIG (ya rellenada para tu proyecto) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAOGIrsV5AxmsDRO4SkDdZQKo5Wmb-ALxI",
      authDomain: "amigo-secreto-reales.firebaseapp.com",
      projectId: "amigo-secreto-reales",
      storageBucket: "amigo-secreto-reales.firebasestorage.app",
      messagingSenderId: "867143308895",
      appId: "1:867143308895:web:75628014ccec2f36e1edea",
      measurementId: "G-4WQ4HJV0X7"
    };

    // Inicializa Firebase y Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Participantes por defecto (ids fijas p1..p8)
    const defaultParticipants = [
      { id:'p1', name:'Joseph' },
      { id:'p2', name:'Jonathan' },
      { id:'p3', name:'Aracelly' },
      { id:'p4', name:'Lorena' },
      { id:'p5', name:'SofÃ­a' },
      { id:'p6', name:'Viviana' },
      { id:'p7', name:'Lidel' },
      { id:'p8', name:'Brighit' }
    ];

    const selectName = document.getElementById('selectName');
    const personalPhoto = document.getElementById('personalPhoto');
    const giftPhoto = document.getElementById('giftPhoto');
    const wish1 = document.getElementById('wish1');
    const wish2 = document.getElementById('wish2');
    const saveBtn = document.getElementById('saveBtn');
    const cardsGrid = document.getElementById('cardsGrid');

    // Inicial: populate select y cards placeholders
    defaultParticipants.forEach(p=>{
      const opt = document.createElement('option');
      opt.value = p.id; opt.textContent = p.name;
      selectName.appendChild(opt);
    });

    // Create (if missing) participant documents with defaults
    async function ensureDefaults(){
      for(const p of defaultParticipants){
        const d = doc(db, 'participants', p.id);
        const snap = await getDoc(d);
        if(!snap.exists()){
          await setDoc(d, {
            id: p.id,
            name: p.name,
            personalPhoto: '', // url
            giftPhoto: '', // url
            wish1: '',
            wish2: '',
            updatedAt: Date.now()
          });
        }
      }
    }

    // Render cards from data map
    function renderCards(dataMap){
      cardsGrid.innerHTML = '';
      // order by defaultParticipants order
      for(const p of defaultParticipants){
        const d = dataMap[p.id] || { name: p.name, personalPhoto:'', giftPhoto:'', wish1:'', wish2:'' };
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <img class="person-photo" src="${escapeAttr(d.personalPhoto) || placeholderPerson(d.name)}" alt="Foto ${d.name}">
          <h3>${escapeHTML(d.name)}</h3>
          <div class="wish"><span class="label">DESEO 1:</span><div>${escapeHTML(d.wish1 || 'â€”')}</div></div>
          <div class="wish"><span class="label">DESEO 2:</span><div>${escapeHTML(d.wish2 || 'â€”')}</div></div>
          ${d.giftPhoto ? `<img class="gift-photo" src="${escapeAttr(d.giftPhoto)}" alt="Regalo ${d.name}">` : ''}
        `;
        cardsGrid.appendChild(card);
      }
    }

    // helpers to avoid basic injection in text inserted as HTML
    function escapeHTML(str=''){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
    function escapeAttr(str){ try{ return str? escapeHTML(str) : ''; }catch(e){return ''} }
    function placeholderPerson(name){
      // generative avatar via initials (ui-avatars)
      return `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=ffcc66&color=111827&rounded=true&size=256`;
    }

    // Escucha cambios en la colecciÃ³n 'participants'
    async function startRealtime(){
      // ensure docs exist
      await ensureDefaults();
      // realtime listener on collection
      const q = query(collection(db, 'participants'));
      onSnapshot(q, (snap) => {
        const map = {};
        snap.forEach(docSnap => {
          map[docSnap.id] = docSnap.data();
        });
        // render cards
        renderCards(map);
        // if current selected name has data, prefill form for that person
        const cur = selectName.value;
        if(map[cur]){
          personalPhoto.value = map[cur].personalPhoto || '';
          giftPhoto.value = map[cur].giftPhoto || '';
          wish1.value = map[cur].wish1 || '';
          wish2.value = map[cur].wish2 || '';
        }
      });
    }

    // Guardar solo la tarjeta seleccionada (por nombre/id)
    saveBtn.addEventListener('click', async ()=>{
      const id = selectName.value;
      if(!id) return alert('Selecciona tu nombre');
      const docRef = doc(db, 'participants', id);
      const payload = {
        personalPhoto: personalPhoto.value.trim(),
        giftPhoto: giftPhoto.value.trim(),
        wish1: wish1.value.trim(),
        wish2: wish2.value.trim(),
        updatedAt: Date.now()
      };
      await setDoc(docRef, { ...(await (await getDoc(docRef)).data()), ...payload }, { merge: true });
      // pequeÃ±a confirmaciÃ³n visual
      saveBtn.textContent = 'Actualizado âœ“';
      setTimeout(()=> saveBtn.textContent = 'Actualizar mi tarjeta', 1200);
    });

    // cuando cambias el selector de nombre, precargar los valores locales (si existen)
    selectName.addEventListener('change', async ()=>{
      const id = selectName.value;
      const snap = await getDoc(doc(db, 'participants', id));
      const data = snap.exists()? snap.data() : null;
      personalPhoto.value = data? data.personalPhoto || '' : '';
      giftPhoto.value = data? data.giftPhoto || '' : '';
      wish1.value = data? data.wish1 || '' : '';
      wish2.value = data? data.wish2 || '' : '';
    });

    // start realtime
    startRealtime();

  </script>
</body>
</html>
