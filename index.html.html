/* ---WISH LIST--- */
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Intercambio - Lista de deseos (Amigo Secreto)</title>
<style>
  :root{
    --bg:#0b1220; --card:#0f1724; --accent:#e53e3e; --accent2:#f6ad55;
    --muted:#94a3b8; --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{margin:0; background: linear-gradient(180deg,#071021 0%, #0f1724 60%); color:#e6eef8; min-height:100vh; padding:24px;}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between; margin-bottom:18px;}
  h1{margin:0;font-size:20px;display:flex;gap:12px;align-items:center;}
  .snow{font-size:20px; transform:rotate(-12deg); opacity:.9;}
  .controls{display:flex;gap:8px;align-items:center;}
  button,select,input,textarea{font:inherit}
  button{background:linear-gradient(90deg,var(--accent),var(--accent2));border:0;padding:8px 12px;border-radius:10px;color:white;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.4)}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 10px}
  main{display:grid;grid-template-columns:320px 1fr;gap:18px;}
  aside{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.5);height:calc(100vh - 140px);overflow:auto}
  .participants{display:flex;flex-direction:column;gap:8px}
  .p-item{display:flex;gap:8px;align-items:center;background:var(--glass);padding:8px;border-radius:8px}
  .p-item input{background:transparent;border:0;color:inherit;flex:1;padding:6px}
  .p-item input:focus{outline:1px dashed rgba(255,255,255,.08)}
  .maincard{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px;border-radius:12px; box-shadow:0 8px 40px rgba(2,6,23,.6); min-height:60vh; overflow:auto}
  .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .card{background:#071226;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .card h3{margin:0 0 6px 0;font-size:15px}
  .wish{display:flex;gap:8px;align-items:flex-start}
  .wish img{width:64px;height:64px;object-fit:cover;border-radius:6px;background:#071226;border:1px solid rgba(255,255,255,0.03)}
  .meta{flex:1}
  .small{font-size:12px;color:var(--muted)}
  .muted{color:var(--muted)}
  .tag{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:12px;margin-top:6px}
  .week-list{margin-top:8px;display:flex;flex-direction:column;gap:6px}
  textarea{width:100%;min-height:64px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  input[type="text"],input[type="url"],input[type="number"]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .row{display:flex;gap:8px}
  .row > *{flex:1}
  .muted-note{font-size:12px;color:var(--muted);margin-top:6px}
  footer{margin-top:12px;color:var(--muted);font-size:13px}
  .top-actions{display:flex;gap:8px;align-items:center}
  .search{padding:8px;border-radius:8px;border:0;background:rgba(255,255,255,0.02);color:inherit;min-width:200px}
  .buy-btn{background:linear-gradient(90deg,#10b981,#047857);padding:6px;border-radius:8px;border:0;color:white;cursor:pointer}
  .small-btn{padding:6px 8px;border-radius:8px;border:0;cursor:pointer}
  .badge{background:rgba(0,0,0,0.4);padding:4px 8px;border-radius:999px;font-size:12px}
  .inline-actions{display:flex;gap:6px;margin-top:8px}
  .note{background:linear-gradient(180deg, rgba(246,237,224,0.02), rgba(255,255,255,0.01));padding:8px;border-radius:8px}
  @media (max-width:900px){
    main{grid-template-columns:1fr; padding-bottom:40px}
    aside{height:auto}
  }
  /* small festive accent */
  .sparkle{display:inline-block;padding:6px;border-radius:50%;background:rgba(255,255,255,0.03)}
</style>
</head>
<body>
<header>
  <h1>üéÑ Amigo Secreto ‚Äî Lista colectiva <span class="snow">‚ùÑÔ∏è</span></h1>
  <div class="controls">
    <div class="top-actions">
      <input id="globalSearch" class="search" placeholder="Buscar por participante, regalo o semana..." />
      <button id="exportBtn" title="Exportar todo como JSON">Exportar</button>
      <button id="importBtn" class="btn-ghost" title="Importar un JSON">Importar</button>
      <input id="fileInput" type="file" accept="application/json" style="display:none" />
      <button id="resetBtn" class="btn-ghost" title="Resetear todo a valores por defecto">Resetear</button>
    </div>
  </div>
</header>

<main>
  <aside>
    <h3 style="margin:0 0 10px 0">Participantes</h3>
    <div class="participants" id="participantsList"></div>

    <div style="margin-top:12px">
      <h4 style="margin:0 0 6px 0">A√±adir participante</h4>
      <div class="row">
        <input id="newName" placeholder="Nombre..." />
        <button id="addParticipant">A√±adir</button>
      </div>
      <div class="muted-note">Cada participante tendr√° su √°rea donde a√±adir deseos y registrar entregas.</div>
    </div>

    <div style="margin-top:12px">
      <h4 style="margin:0 0 6px 0">Export / Import</h4>
      <div class="muted-note">Usa exportar para generar el archivo maestro y comp√°rtelo; usa importar para cargar actualizaciones desde otros dispositivos.</div>
    </div>

    <footer>
      <div style="margin-top:8px" class="muted">Creado por tu asistente ‚Äî copia local. Usa export/import para compartir entre dispositivos.</div>
    </footer>
  </aside>

  <section class="maincard">
    <div class="toolbar">
      <div>
        <label class="small muted">Seleccionar participante</label>
        <select id="participantSelect"></select>
      </div>

      <div style="flex:1">
        <label class="small muted">A√±adir deseo</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="wishTitle" placeholder="T√≠tulo del regalo (ej: Chocolates, Libro...)" />
          <input id="wishPrice" placeholder="Precio (opcional)" />
          <button id="addWish">Agregar deseo</button>
        </div>
        <input id="wishLink" placeholder="Enlace (opcional)" style="margin-top:6px" />
        <input id="wishImage" placeholder="URL imagen (opcional)" style="margin-top:6px" />
      </div>

      <div style="min-width:220px">
        <label class="small muted">Registrar entrega semanal</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <select id="weekSelect">
            <option value="Semana 1">Semana 1</option>
            <option value="Semana 2">Semana 2</option>
            <option value="Semana 3">Semana 3</option>
            <option value="Semana 4">Semana 4</option>
            <option value="Otro">Otro</option>
          </select>
          <input id="weekNote" placeholder="Nota corta (ej: Dulces entregados)" />
          <button id="addWeek">Registrar</button>
        </div>
      </div>
    </div>

    <div style="margin-top:10px; display:flex; gap:12px; align-items:center; flex-wrap:wrap">
      <div class="badge" id="countBadge">Participantes: 0</div>
      <div class="muted small">Todos pueden ver y editar las listas.</div>
    </div>

    <hr style="border:none;height:8px" />

    <div id="gridArea" class="grid"></div>
  </section>
</main>

<script>
/* --- Data model and persistence --- */
const STORAGE_KEY = 'amigo_secreto_v1';

// default 8 participants if none
const defaultState = () => {
  const participants = [];
  for(let i=1;i<=8;i++){
    participants.push({
      id: 'p'+i,
      name: 'Participante ' + i,
      wishes: [], // {id,title,desc,link,price,img,bought}
      weeks: [] // {id,week,note,ts}
    });
  }
  return {participants, createdAt: Date.now()};
};

let state = loadState();

function loadState(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return defaultState();
    return JSON.parse(raw);
  } catch(e) { console.error('load',e); return defaultState(); }
}

function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

/* --- Utilities --- */
function uid(prefix='x'){ return prefix + Math.random().toString(36).slice(2,9); }
function el(tag, attrs={}, ...children){
  const node = document.createElement(tag);
  for(const k in attrs){
    if(k.startsWith('on') && typeof attrs[k] === 'function') node.addEventListener(k.slice(2), attrs[k]);
    else if(k==='html') node.innerHTML = attrs[k];
    else node.setAttribute(k, attrs[k]);
  }
  for(const c of children) if(c!==null) node.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
  return node;
}

/* --- UI binding --- */
const participantsList = document.getElementById('participantsList');
const participantSelect = document.getElementById('participantSelect');
const gridArea = document.getElementById('gridArea');
const countBadge = document.getElementById('countBadge');

function renderParticipants(){
  participantsList.innerHTML = '';
  participantSelect.innerHTML = '';
  state.participants.forEach((p, idx) => {
    const container = el('div',{class:'p-item'});
    const input = el('input',{value:p.name, oninput:(e)=>{ p.name = e.target.value; saveState(); renderAll(); }});
    const del = el('button',{class:'btn-ghost', onclick:()=>{ if(confirm('Eliminar '+p.name+'?')){ state.participants = state.participants.filter(x=>x.id!==p.id); saveState(); renderAll(); } }}, 'Eliminar');
    container.appendChild(input);
    container.appendChild(del);
    participantsList.appendChild(container);

    const opt = el('option', {value:p.id}, p.name);
    participantSelect.appendChild(opt);
  });
  countBadge.textContent = 'Participantes: ' + state.participants.length;
}

function renderGrid(filterText=''){
  gridArea.innerHTML = '';
  const q = filterText.toLowerCase().trim();
  state.participants.forEach(p => {
    // filter logic: include if participant name or any wish or week matches query
    let show = true;
    if(q){
      const inName = p.name.toLowerCase().includes(q);
      const inWishes = p.wishes.some(w => (w.title||'').toLowerCase().includes(q) || (w.link||'').toLowerCase().includes(q));
      const inWeeks = p.weeks.some(wk => (wk.week||'').toLowerCase().includes(q) || (wk.note||'').toLowerCase().includes(q));
      show = inName || inWishes || inWeeks;
    }
    if(!show) return;

    const card = el('div',{class:'card'});
    const header = el('div',{}, el('h3',{}, p.name));
    const infoRow = el('div',{class:'small muted'}, `Deseos: ${p.wishes.length} ‚Ä¢ Entregas: ${p.weeks.length}`);
    card.appendChild(header);
    card.appendChild(infoRow);

    // wishes list
    if(p.wishes.length){
      p.wishes.forEach(w => {
        const wishEl = el('div',{class:'wish', style:'margin-top:10px'});
        const img = el('img',{src: w.img || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"></svg>'});
        const meta = el('div',{class:'meta'});
        const title = el('div',{}, el('strong',{}, w.title || '(sin t√≠tulo)'));
        const small = el('div',{class:'small muted'}, w.desc || '');
        const price = el('div',{class:'small muted'}, w.price ? ('S/ ' + w.price) : '');
        const link = w.link ? el('div',{}, el('a',{href:w.link, target:'_blank'}, 'Enlace')) : null;
        const tag = el('div',{class:'tag'}, w.bought ? 'Comprado' : 'Pendiente');

        const actions = el('div',{class:'inline-actions'});
        const toggle = el('button',{class:'small-btn', onclick:()=>{ w.bought = !w.bought; saveState(); renderAll(); }}, w.bought ? 'Desmarcar' : 'Marcar comprado');
        const edit = el('button',{class:'small-btn', onclick:()=> editWish(p.id, w.id) }, 'Editar');
        const rem = el('button',{class:'small-btn', onclick:()=> { if(confirm('Eliminar este deseo?')){ p.wishes = p.wishes.filter(x=>x.id!==w.id); saveState(); renderAll(); } } }, 'Eliminar');

        meta.appendChild(title);
        if(small) meta.appendChild(small);
        if(price) meta.appendChild(price);
        if(link) meta.appendChild(link);
        meta.appendChild(tag);
        actions.appendChild(toggle); actions.appendChild(edit); actions.appendChild(rem);
        meta.appendChild(actions);

        wishEl.appendChild(img); wishEl.appendChild(meta);
        card.appendChild(wishEl);
      });
    } else {
      card.appendChild(el('div',{class:'muted-note', style:'margin-top:10px'}, 'No hay deseos a√∫n.'));
    }

    // weekly deliveries
    card.appendChild(el('h4',{style:'margin-top:10px;margin-bottom:6px'}, 'Entregas / Semanas'));
    if(p.weeks.length){
      const wl = el('div',{class:'week-list'});
      p.weeks.slice().reverse().forEach(wk => {
        const item = el('div',{class:'note'}, el('div',{style:'display:flex;justify-content:space-between;align-items:center'}, el('strong',{}, wk.week), el('span',{class:'small muted'}, new Date(wk.ts).toLocaleString())), el('div',{class:'small muted'}, wk.note || '‚Äî'), el('div',{style:'margin-top:6px',class:'inline-actions'}, el('button',{class:'small-btn', onclick:()=>{ if(confirm('Eliminar registro?')){ p.weeks = p.weeks.filter(x=>x.id!==wk.id); saveState(); renderAll(); } }}, 'Eliminar')));
        wl.appendChild(item);
      });
      card.appendChild(wl);
    } else {
      card.appendChild(el('div',{class:'muted-note'}, 'No hay entregas registradas.'));
    }

    gridArea.appendChild(card);
  });
}

/* --- Editing features --- */
function addParticipant(name){
  const p = { id: uid('p'), name: name || ('Participante ' + (state.participants.length+1)), wishes: [], weeks: [] };
  state.participants.push(p);
  saveState(); renderAll();
}

function addWishToSelected(){
  const pid = participantSelect.value;
  if(!pid) return alert('Selecciona un participante primero');
  const p = state.participants.find(x=>x.id===pid);
  const title = document.getElementById('wishTitle').value.trim();
  if(!title) return alert('El t√≠tulo del deseo es requerido');
  const link = document.getElementById('wishLink').value.trim();
  const img = document.getElementById('wishImage').value.trim();
  const price = document.getElementById('wishPrice').value.trim();
  const w = { id: uid('w'), title, desc:'', link, img, price, bought:false };
  p.wishes.push(w);
  document.getElementById('wishTitle').value=''; document.getElementById('wishLink').value=''; document.getElementById('wishImage').value=''; document.getElementById('wishPrice').value='';
  saveState(); renderAll();
}

function editWish(pid, wid){
  const p = state.participants.find(x=>x.id===pid);
  const w = p.wishes.find(x=>x.id===wid);
  const newTitle = prompt('Editar t√≠tulo', w.title);
  if(newTitle===null) return;
  w.title = newTitle;
  const newPrice = prompt('Editar precio (dejar vac√≠o si no aplica)', w.price||'');
  if(newPrice!==null) w.price = newPrice;
  const newLink = prompt('Editar enlace', w.link||'');
  if(newLink!==null) w.link = newLink;
  const newImg = prompt('Editar URL imagen', w.img||'');
  if(newImg!==null) w.img = newImg;
  saveState(); renderAll();
}

function addWeekToSelected(){
  const pid = participantSelect.value;
  if(!pid) return alert('Selecciona un participante');
  const p = state.participants.find(x=>x.id===pid);
  const week = document.getElementById('weekSelect').value;
  const note = document.getElementById('weekNote').value.trim();
  if(!note) return alert('Escribe una nota para la entrega');
  p.weeks.push({ id: uid('wk'), week, note, ts: Date.now() });
  document.getElementById('weekNote').value='';
  saveState(); renderAll();
}

/* --- Export / Import --- */
function exportJSON(){
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'amigo_secreto_export.json'; document.body.appendChild(a); a.click();
  a.remove(); URL.revokeObjectURL(url);
}

function importJSONFile(file){
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const parsed = JSON.parse(ev.target.result);
      if(!parsed.participants) throw new Error('Formato inv√°lido');
      // simple merge: replace entire state
      if(confirm('Importar este archivo reemplazar√° la sesi√≥n actual. ¬øContinuar?')){
        state = parsed;
        saveState();
        renderAll();
      }
    } catch(err){
      alert('Error al importar: ' + err.message);
    }
  };
  reader.readAsText(file);
}

/* --- Reset --- */
function resetAll(){
  if(confirm('¬øResetear todo al estado inicial? Se perder√°n cambios no exportados.')){
    state = defaultState();
    saveState();
    renderAll();
  }
}

/* --- Global render --- */
function renderAll(search=''){
  renderParticipants();
  renderGrid(search);
  // ensure participantSelect has a value
  if(!participantSelect.value && state.participants.length) participantSelect.value = state.participants[0].id;
}

document.getElementById('addParticipant').addEventListener('click', ()=>{
  const v = document.getElementById('newName').value.trim();
  if(!v) return alert('Escribe un nombre');
  addParticipant(v);
  document.getElementById('newName').value='';
});
document.getElementById('addWish').addEventListener('click', addWishToSelected);
document.getElementById('addWeek').addEventListener('click', addWeekToSelected);
document.getElementById('exportBtn').addEventListener('click', exportJSON);
document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('fileInput').click());
document.getElementById('fileInput').addEventListener('change', (e)=> {
  if(e.target.files && e.target.files[0]) importJSONFile(e.target.files[0]);
});
document.getElementById('resetBtn').addEventListener('click', resetAll);
document.getElementById('globalSearch').addEventListener('input', (e)=> renderAll(e.target.value));

/* initial render */
renderAll();
</script>
</body>
</html>


